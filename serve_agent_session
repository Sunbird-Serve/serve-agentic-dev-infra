CREATE TABLE IF NOT EXISTS public.serve_agent_sessions
(
    session_id uuid NOT NULL,
    wa_phone text COLLATE pg_catalog."default" NOT NULL,
    conversation_id text COLLATE pg_catalog."default",
    state text COLLATE pg_catalog."default" NOT NULL,
    sub_state text COLLATE pg_catalog."default",
    last_agent_prompt_id text COLLATE pg_catalog."default",
    last_outbound_msg_id text COLLATE pg_catalog."default",
    temp_name text COLLATE pg_catalog."default",
    temp_email text COLLATE pg_catalog."default",
    temp_phone text COLLATE pg_catalog."default",
    eligibility_status text COLLATE pg_catalog."default",
    eligibility_fail_reason text COLLATE pg_catalog."default",
    eligibility_checked_at timestamp without time zone,
    device_policy text COLLATE pg_catalog."default" NOT NULL DEFAULT 'laptop_or_tablet_only'::text,
    available_days jsonb,
    available_time_bands jsonb,
    retries jsonb,
    tool_state jsonb,
    ended boolean NOT NULL DEFAULT false,
    end_reason text COLLATE pg_catalog."default",
    created_at timestamp without time zone NOT NULL DEFAULT now(),
    updated_at timestamp without time zone NOT NULL DEFAULT now(),
    expires_at timestamp without time zone NOT NULL,
    CONSTRAINT serve_agent_sessions_pkey PRIMARY KEY (session_id),
    CONSTRAINT serve_agent_sessions_wa_phone_key UNIQUE (wa_phone)
)

TABLESPACE pg_default;

ALTER TABLE IF EXISTS public.serve_agent_sessions
    OWNER to serve_agentic_user;
-- Index: idx_serve_agent_sessions_expires

-- DROP INDEX IF EXISTS public.idx_serve_agent_sessions_expires;

CREATE INDEX IF NOT EXISTS idx_serve_agent_sessions_expires
    ON public.serve_agent_sessions USING btree
    (expires_at ASC NULLS LAST)
    TABLESPACE pg_default;
-- Index: idx_serve_agent_sessions_state

-- DROP INDEX IF EXISTS public.idx_serve_agent_sessions_state;

CREATE INDEX IF NOT EXISTS idx_serve_agent_sessions_state
    ON public.serve_agent_sessions USING btree
    (state COLLATE pg_catalog."default" ASC NULLS LAST)
    TABLESPACE pg_default;
-- Index: idx_serve_agent_sessions_updated

-- DROP INDEX IF EXISTS public.idx_serve_agent_sessions_updated;

CREATE INDEX IF NOT EXISTS idx_serve_agent_sessions_updated
    ON public.serve_agent_sessions USING btree
    (updated_at ASC NULLS LAST)
    TABLESPACE pg_default;
